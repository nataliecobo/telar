name: Build and Deploy Telar Site

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_iiif:
        description: 'Force IIIF tile regeneration'
        type: boolean
        default: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch data from Google Sheets (if enabled)
        run: |
          # Check if Google Sheets integration is enabled in _config.yml
          ENABLED=$(python3 -c "import yaml; config=yaml.safe_load(open('_config.yml')); print(config.get('google_sheets', {}).get('enabled', False))")

          if [ "$ENABLED" = "True" ]; then
            echo "✓ Google Sheets integration enabled - fetching CSVs..."
            python3 scripts/fetch_google_sheets.py
          else
            echo "✓ Google Sheets integration disabled - using existing CSV files"
          fi

      - name: Convert CSV to JSON
        run: |
          python scripts/csv_to_json.py

      - name: Generate Jekyll collections
        run: |
          python scripts/generate_collections.py

      - name: Build Jekyll site
        run: |
          bundle exec jekyll build

      - name: Restore IIIF tiles from cache
        id: cache-iiif
        uses: actions/cache/restore@v4
        with:
          path: cached-iiif/
          key: iiif-tiles-${{ hashFiles('components/images/objects/**') }}

      - name: Detect if IIIF regeneration is needed
        id: detect-changes
        run: |
          # Failsafe: Default to regenerating IIIF (safe default)
          NEEDS_IIIF="true"

          # Only attempt detection for push events (not manual triggers)
          if [ "${{ github.event_name }}" = "push" ]; then
            # Check if this is the first commit (no previous commit to compare)
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              # Get list of changed files
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

              # Check if any images or objects.csv changed
              if echo "$CHANGED_FILES" | grep -qE '^components/images/objects/|^components/structures/objects\.csv$'; then
                echo "✓ Images or objects.csv changed - IIIF regeneration needed"
                NEEDS_IIIF="true"
              else
                echo "✓ Only content files changed - skipping IIIF regeneration"
                NEEDS_IIIF="false"
              fi
            else
              echo "✓ First commit - running full build with IIIF"
              NEEDS_IIIF="true"
            fi
          else
            echo "✓ Manual trigger - using input parameter (force_iiif=${{ inputs.force_iiif }})"
            NEEDS_IIIF="${{ inputs.force_iiif }}"
          fi

          echo "needs_iiif=$NEEDS_IIIF" >> $GITHUB_OUTPUT
          echo "IIIF regeneration: $NEEDS_IIIF"

      - name: Generate IIIF tiles into _site
        if: steps.detect-changes.outputs.needs_iiif == 'true'
        run: |
          # Check if source images directory exists
          if [ -d "components/images/objects" ]; then
            # Extract URL and baseurl from _config.yml
            SITE_URL=$(python3 -c "import yaml; config=yaml.safe_load(open('_config.yml')); print(config.get('url', ''))")
            BASE_URL=$(python3 -c "import yaml; config=yaml.safe_load(open('_config.yml')); print(config.get('baseurl', ''))")
            FULL_URL="${SITE_URL}${BASE_URL}"

            echo "Generating IIIF tiles with base URL: $FULL_URL"

            python scripts/generate_iiif.py \
              --source-dir components/images/objects \
              --output-dir _site/iiif/objects \
              --base-url "$FULL_URL"
          else
            echo "No components/images/objects directory found. Skipping IIIF generation."
          fi

      - name: Copy generated IIIF tiles to cache directory
        if: steps.detect-changes.outputs.needs_iiif == 'true'
        run: |
          if [ -d "_site/iiif/objects" ]; then
            echo "✓ Copying IIIF tiles to cache directory for future builds"
            mkdir -p cached-iiif
            cp -r _site/iiif/objects/* cached-iiif/
          fi

      - name: Save IIIF tiles to cache
        if: steps.detect-changes.outputs.needs_iiif == 'true'
        uses: actions/cache/save@v4
        with:
          path: cached-iiif/
          key: iiif-tiles-${{ hashFiles('components/images/objects/**') }}

      - name: Restore IIIF tiles from cache to _site (when skipping regeneration)
        if: steps.detect-changes.outputs.needs_iiif == 'false'
        run: |
          if [ -d "cached-iiif" ] && [ "$(ls -A cached-iiif)" ]; then
            echo "✓ Restoring IIIF tiles from cache"
            mkdir -p _site/iiif/objects
            cp -r cached-iiif/* _site/iiif/objects/
            echo "✓ IIIF tiles restored successfully"
          else
            echo "⚠️  Warning: No cached IIIF tiles found. Site may have missing images."
            echo "⚠️  Run a full build with IIIF regeneration to create tiles."
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
